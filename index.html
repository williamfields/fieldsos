<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
	<title>FieldsOS</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.48/Tone.js"></script>
    <style>
        body 
        {
            background-color: #DDDDDD;
        }
        .valueDisplay
        {
            font-size:1.5em;
            margin-left:1em;
        }
        .slider
        {
            width:50%;
            max-width:400px;
        }
        .selector
        {
            height:4em;
            width:4em;
            margin:2em;        
        }
        .selectorLabel
        {
            font-size:2em;  
        }
        
    </style>
</head>

<body>

    <div style="position:absolute; top:50%; transform: translate(-50%, -50%); left:50%; width:80vw; text-align:center;">
        
<button id="b" onClick="go();" style="font-size:85px; border:0px; background-color:rgba(0,0,0,0);">‚ñ∂Ô∏è</button> <button id="regenButton" onClick="regen();" style="font-size:85px; border:0px; background-color:rgba(0,0,0,0);">üîÅ</button>

<pre>                    
  TEMPO: <input type="range" class="slider" min="1" max="200" value="120" oninput="document.getElementById('tempoDisplay').innerHTML=String(this.value).padStart(3,' ');" onchange="Tone.Transport.bpm.value=tempo=this.value; document.getElementById('tempoDisplay').innerHTML=String(this.value).padStart(3,' ');"><span id="tempoDisplay"  class="valueDisplay" >120</span>

<hr/>

  STEPS: <input type="range" class="slider" min="1" max="16" value="16" oninput="document.getElementById('stepsDisplay').innerHTML=String(this.value).padStart(3,' ');" onchange="stepsChanged(this.value);"><span class="valueDisplay" id="stepsDisplay"> 16</span>

  MULTI: <input type="range" class="slider" min="1" max="16" value="4" oninput="document.getElementById('multiDisplay').innerHTML=String(this.value).padStart(3,' ');" onchange="multiChanged(this.value);"><span  class="valueDisplay" id="multiDisplay">  8</span>

DENSITY: <input type="range" class="slider" min="0" max="100" value="100" oninput="document.getElementById('densityDisplay').innerHTML=String(this.value).padStart(3,' ');" onchange="densityChanged(this.value);"><span  class="valueDisplay" id="densityDisplay">100</span>

  DECAY: <input type="range" class="slider" min="1" max="100" value="50" oninput="document.getElementById('decayDisplay').innerHTML=String(this.value).padStart(3,' ');" onchange="decayChanged(this.value);"><span  class="valueDisplay" id="decayDisplay">50</span>

</pre>

<div style="width:320px; margin:0 auto; text-align:center;">
<div style="float:left;">
    <div>
        <input type="checkbox" class="selector" id="bdSelector" checked="checked" onchange="bdSelected=this.checked;">
    </div>
    <div>
        <label for="bdSelector" class="selectorLabel">BD</label>
    </div>
</div>
<div style="float:left;">
    <div>
        <input type="checkbox" class="selector" id="hatSelector" checked="checked" onchange="hatSelected=this.checked;">
    </div>
    <div>
        <label for="hatSelector" class="selectorLabel">HAT</label>
    </div>
</div>
<div style="float:left;">
    <div>
        <input type="checkbox" class="selector" id="snrSelector" label="SNR" checked="checked" onchange="snrSelected=this.checked;">
    </div>
    <div>
        <label for="snrSelector" class="selectorLabel">SNR</label>
    </div>
</div>
<br/>
</div>

</div>

	<script type="text/javascript">
       
        // ------------------------------------------------
        // CONTROLS
        // ------------------------------------------------

        var playing = false;
        var tempo = 120;
        var bdSelected = true;
        var hatSelected = true;
        var snrSelected = true;

        function go()
        {
            if (!playing)
            {
                play();
                playing = true;
                document.getElementById("b").innerHTML = '‚è∏';
            }                
            else
            {
                stop();
                playing = false;
                document.getElementById("b").innerHTML = '‚ñ∂Ô∏è';
            }                
        }

        function stop()
        {
            loop.stop();
            Tone.Transport.stop();  
        }

        function play()
        {                        
            counter = 0;
            bdSeqPos = 0;
            hatSeqPos = 0;
            snrSeqPos = 0;

            Tone.Transport.start();                        
            loop.start(0);
        }

        function regen()
        {
            document.getElementById("regenButton").style.backgroundColor='yellow';
            setTimeout(()=>{
                document.getElementById("regenButton").style.backgroundColor='#DDDDDD';
            },100);

            bdSeq = getSequence(0.2);
            hatSeq = getSequence(0.75);
            snrSeq = getSequence(0.2);
        }

        function stepsChanged(value)
        {                        
            if (bdSelected)
            {
                bdSeqSteps=value;
            }
            if (hatSelected)
            {
                hatSeqSteps=value;
            }
            if (snrSelected)
            {
                snrSeqSteps=value;
            }            
        }

        function multiChanged(value)
        {
            if (bdSelected)
            {
                bdSeqMulti=value;
            }
            if (hatSelected)
            {
                hatSeqMulti=value;
            }
            if (snrSelected)
            {
                snrSeqMulti=value;
            }            
        }

        function densityChanged(value)
        {
            if (bdSelected)
            {
                bdDensity=value;
            }
            if (hatSelected)
            {
                hatDensity=value;
            }
            if (snrSelected)
            {
                snrDensity=value;
            }            
        }

        function decayChanged(value)
        {
            if (bdSelected)
            {
                bdSynth.set({
                    envelope: {
                        release: 10,
                        decay: 0.01 + Math.pow((value/100),3)
                    }
                });
            }
            if (hatSelected)
            {
                hatSynth.set({
                    envelope: {
                        release: 10,
                        decay: 0.01 + Math.pow((value/100),3)
                    }
                });
            }
            if (snrSelected)
            {
                snareToneSynth.set({
                    envelope: {
                        release: 10,
                        decay: 0.01 + Math.pow((value/100),2)*0.1
                    }
                });
                snareNoiseSynth.set({
                    envelope: {
                        release: 10,
                        decay: 0.01 + Math.pow((value/100),2)*0.3
                    }
                });

            }            
        }

        // ------------------------------------------------
        // SYNTHS
        // ------------------------------------------------
    
        function bd(time, vel)
        {
            if (typeof bdSynth == "undefined")
            {
                bdSynth = new Tone.MembraneSynth(
                    {
                        volume: 6,
                        octaves: 5,
                        envelope: {
                            decay: 0.01 + Math.pow((bdDecay/100),3),  // TODO: Fix so same logic is not in two places
                            release: 10
                        }
                    }).toDestination();
            }
            bdSynth.triggerAttackRelease(60, "16n", time, vel);
        }

        function hat(time, vel)
        {
            if (typeof hatSynth == "undefined")
            {
                hatSynth = new Tone.MetalSynth({
                    harmonicity: 4,
                    resonance: 500,
                    modulationIndex: 128,
                    envelope: {                        
                        decay: 0.01 + Math.pow((hatDecay/100),3),  // TODO: Fix so same logic is not in two places
                        release: 10
                    },
                    volume: -6
                }).toDestination();
            }
            hatSynth.triggerAttackRelease("C4", "32n", time, vel);
        }

        function snr(time,vel)
        {
            if (typeof snareNoiseSynth == "undefined")
            {
                snareNoiseSynth = new Tone.NoiseSynth({
                    noise: {
                        type: "white"
                    },
                    envelope: {
                        decay: 0.01 + Math.pow((snrDecay/100),2)*0.3,  // TODO: Fix so same logic is not in two places
                        release: 10
                    },
                    volume: -0
                }).toDestination();

                snareToneSynth = new Tone.MembraneSynth({
                        volume: -6,
                        octaves: 1,
                        envelope: {
                            decay: 0.01 + Math.pow((snrDecay/100),2)*0.1,  // TODO: Fix so same logic is not in two places
                            release: 10
                        }
                    }).toDestination();                
            }

            snareNoiseSynth.triggerAttackRelease("64n", time, vel);
            snareToneSynth.triggerAttackRelease(400, "64n", time, vel);       
        }


        // ------------------------------------------------
        // SEQUENCING
        // ------------------------------------------------
        
        //var bdSeq = [1, 0, 0, 0.25, 0, 0, 1, 0, 1, 0, 0, 0.25, 0.25, 0, 1, 0];
        var bdSeq = [];
        var bdSeqSteps = 16;
        var bdSeqMulti = 8;
        var bdSeqPos = 0;
        var bdSeqPosPrev = -1;
        var bdDensity = 100;        
        var bdDecay = 50;

        //var hatSeq = [1, 1, 1, 1, 1, 0, 1, 0, 1, 0.25, 1, 0, 1, 0.25, 1, 0.25];
        var hatSeq = [];
        var hatSeqSteps = 16;
        var hatSeqMulti = 8;
        var hatSeqPos = 0;
        var hatSeqPosPrev = -1;
        var hatDensity = 100;
        var hatDecay = 50;
 
        //var snrSeq = [0, 0, 0, 0, 1, 0, 0, 0.25, 0, 0.25, 0, 0, 1, 0, 0, 0.5];
        var snrSeq = [];
        var snrSeqSteps = 16;
        var snrSeqMulti = 8;
        var snrSeqPos = 0;
        var snrSeqPosPrev = -1;
        var snrDensity = 100;        
        var snrDecay = 50;

        regen(); 

        
        const loop = new Tone.Loop((time) => {
                                                 
            // BD
            if (bdSeqSteps == 1)  // Special case when step count is 1
            {
                bdSeqPos = Math.floor((counter/32)*bdSeqMulti) % 2; // Pretend there are two steps
                bdSeqPosEffective = 0;                              // But always use the first value
            }
            else
            {
                bdSeqPos = Math.floor((counter/32)*bdSeqMulti) % bdSeqSteps;
                bdSeqPosEffective = bdSeqPos;
            }            
            if (bdSeqPos != bdSeqPosPrev)
            {            
                if (bdSeq[bdSeqPosEffective] > 0 && Math.random() < bdSeq[bdSeqPosEffective]) {
                    if (Math.random() < bdDensity/100)
                    {
                        bd(time, bdSeq[bdSeqPosEffective]);
                    }                    
                }
            }
            bdSeqPosPrev = bdSeqPos;

            // HAT
            if (hatSeqSteps == 1)  // Special case when step count is 1
            {
                hatSeqPos = Math.floor((counter/32)*hatSeqMulti) % 2; // Pretend there are two steps
                hatSeqPosEffective = 0;                              // But always use the first value
            }
            else
            {
                hatSeqPos = Math.floor((counter/32)*hatSeqMulti) % hatSeqSteps;
                hatSeqPosEffective = hatSeqPos;
            }            
            if (hatSeqPos != hatSeqPosPrev)
            {            
                if (hatSeq[hatSeqPosEffective] > 0 && Math.random() < hatSeq[hatSeqPosEffective]) {
                    if (Math.random() < hatDensity/100)
                    {
                        hat(time, hatSeq[hatSeqPosEffective]);
                    }                    
                }
            }
            hatSeqPosPrev = hatSeqPos;

            // SNR
            if (snrSeqSteps == 1)  // Special case when step count is 1
            {
                snrSeqPos = Math.floor((counter/32)*snrSeqMulti) % 2; // Pretend there are two steps
                snrSeqPosEffective = 0;                              // But always use the first value
            }
            else
            {
                snrSeqPos = Math.floor((counter/32)*snrSeqMulti) % snrSeqSteps;
                snrSeqPosEffective = snrSeqPos;
            }            
            if (snrSeqPos != snrSeqPosPrev)
            {            
                if (snrSeq[snrSeqPosEffective] > 0 && Math.random() < snrSeq[snrSeqPosEffective]) {
                    if (Math.random() < snrDensity/100)
                    {
                        snr(time, snrSeq[snrSeqPosEffective]);
                    }                    
                }
            }
            snrSeqPosPrev = snrSeqPos;


            counter++;

        }, "64n");

  

        // ------------------------------------------------
        // HELPERS
        // ------------------------------------------------
                
        function randInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function probDo(x) 
        {
            return Math.random() < x;
        }


        function getSequence(seqDensity)
        {		
            var seq = [];
            for (var i=0;i<16;i++)
            {
                var f = 0;
                var r = Math.random();
                if (r < seqDensity)
                {
                    f = 1;
                }
                else if (r < 0.3)
                {
                    f = Math.random();				
                }
                else
                {
                    f = 0;
                }
                seq[i] = f;
            }

            if (probDo(0.5))
            {
                seq[0] = 1;
            }

            return seq;
        }

	</script>
</body>
</html>
