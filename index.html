<!DOCTYPE html>

<html>
    <head>
    <meta charset="utf-8">
        <title>FieldsOS</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.48/Tone.js"></script>
        <link rel="stylesheet" href="fieldsos.css">
    </head>

    <body>

        <div class="container">

            <div class="buttonContainer">
                <button id="b" class="controlButton" onClick="go();">‚ñ∂Ô∏è</button>
                <button id="regenButton" class="controlButton" onClick="regen();">üîÅ</button>
            </div>

            <select class="algoSelector" onChange="algo = this.options[this.selectedIndex].value;">
                <option value="random">Totally random</option>
                <option value="hiphop">Hiphop</option>
            </select>

            <div class="sliderContainer">
                <div class="sliderLabel">TEMPO</div>                    
                <input id="tempoSlider" type="range" class="slider" min="1" max="200" value="120" oninput="document.getElementById('tempoDisplay').innerHTML=this.value;" onchange="Tone.Transport.bpm.value=tempo=this.value; document.getElementById('tempoDisplay').innerHTML=this.value;"><span id="tempoDisplay"  class="valueDisplay" >120</span>
            </div>
            <div class="sliderContainer">
                <div class="sliderLabel">STEPS</div>
                <input type="range" class="slider" min="1" max="16" value="16" oninput="document.getElementById('stepsDisplay').innerHTML=this.value;" onchange="stepsChanged(this.value);"><span class="valueDisplay" id="stepsDisplay"> 16</span>
            </div>
            <div class="sliderContainer">
                <div class="sliderLabel">MULTI</div>
                <input type="range" class="slider" min="1" max="16" value="8" oninput="document.getElementById('multiDisplay').innerHTML=this.value;" onchange="multiChanged(this.value);"><span  class="valueDisplay" id="multiDisplay">  8</span>
            </div>
            <div class="sliderContainer">
                <div class="sliderLabel">RANDOM</div>
                <input type="range" class="slider" min="0" max="100" value="0" oninput="document.getElementById('randomnessDisplay').innerHTML=this.value;" onchange="randomnessChanged(this.value);"><span  class="valueDisplay" id="randomnessDisplay">  0</span>
            </div>
            <div class="sliderContainer">                
                <div class="sliderLabel">DENSITY</div>
                <input type="range" class="slider" min="0" max="100" value="100" oninput="document.getElementById('densityDisplay').innerHTML=this.value;" onchange="densityChanged(this.value);"><span  class="valueDisplay" id="densityDisplay">100</span>
            </div>
            <div class="sliderContainer">
                <div class="sliderLabel">DECAY</div>
                <input type="range" class="slider" min="1" max="100" value="50" oninput="document.getElementById('decayDisplay').innerHTML=this.value;" onchange="decayChanged(this.value);"><span  class="valueDisplay" id="decayDisplay"> 50</span>
            </div>

            <div class="checkboxContainer">
                <div class="checkboxSubContainer">                
                <div>
                    <input type="checkbox" class="selector" id="bdSelector" checked="checked" onchange="bdSelected=this.checked;">
                </div>
                <div>
                    <label for="bdSelector">BD</label>
                </div>
                </div>
                <div class="checkboxSubContainer">
                    <div>
                        <input type="checkbox" class="selector" id="hatSelector" checked="checked" onchange="hatSelected=this.checked;">
                    </div>
                    <div>
                        <label for="hatSelector">HAT</label>
                    </div>
                </div>
                <div class="checkboxSubContainer">
                    <div>
                        <input type="checkbox" class="selector" id="snrSelector" label="SNR" checked="checked" onchange="snrSelected=this.checked;">
                    </div>
                    <div>
                        <label for="snrSelector">SNR</label>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript" src="util.js"></script>
        <script type="text/javascript" src="patches.js"></script>
        <script type="text/javascript" src="algos.js"></script>
        <script type="text/javascript">

            // ------------------------------------------------
            // CONTROLS
            // ------------------------------------------------

            var playing = false;
            var tempo = 120;
            var bdSelected = true;
            var hatSelected = true;
            var snrSelected = true;
            var algo = "random";

            function go()
            {
                if (!playing)
                {
                    play();
                    playing = true;
                    document.getElementById("b").innerHTML = '‚è∏';
                }                
                else
                {
                    stop();
                    playing = false;
                    document.getElementById("b").innerHTML = '‚ñ∂Ô∏è';
                }                
            }

            function stop()
            {
                loop.stop();
                Tone.Transport.stop();  
            }

            function play()
            {                        
                counter = 0;
                Tone.Transport.start();                        
                loop.start(0);
            }

            function regen()
            {
                document.getElementById("regenButton").style.backgroundColor='yellow';
                setTimeout(()=>{
                    document.getElementById("regenButton").style.backgroundColor='#DDDDDD';
                },100);

                switch (algo)
                {
                    case "random": algoRandom(); break;
                    case "hiphop": algoHiphop(); break;
                }
                
                bd.update();
                hat.update();
                snr.update();
            }

            function stepsChanged(value)
            {                        
                if (bdSelected)  bd.seqSteps=value;
                if (hatSelected) hat.seqSteps=value;
                if (snrSelected) snr.seqSteps=value;
            }

            function multiChanged(value)
            {
                if (bdSelected) bd.seqMulti=value;
                if (hatSelected) hat.seqMulti=value;
                if (snrSelected) snr.seqMulti=value;
            }

            function densityChanged(value)
            {
                if (bdSelected) bd.density=value;
                if (hatSelected) hat.density=value;
                if (snrSelected) snr.density=value;
            }

            function randomnessChanged(value)
            {
                if (bdSelected) bd.randomness=value;
                if (hatSelected) hat.randomness=value;
                if (snrSelected) snr.randomness=value;
            }

            function decayChanged(value)
            {
                if (bdSelected) 
                {
                    bd.decay = value;
                    bd.update();
                }
                if (hatSelected)
                {
                    hat.decay = value;
                    hat.update();
                }            
                if (snrSelected) 
                {
                    snr.decay = value;
                    snr.update();
                }
            }

            // ------------------------------------------------
            // SEQUENCING
            // ------------------------------------------------
            
            var bd = new BdPatch();
            var hat = new HatPatch(); 
            var snr = new SnrPatch();

            const loop = new Tone.Loop((time) => {
                                                    
                executeSequence(bd, time);
                executeSequence(hat, time);
                executeSequence(snr, time);

                counter++;

            }, "64n");
    

            function executeSequence(obj, time)
            {
                if (obj.seqSteps == 1)  // Special case when step count is 1
                {
                    obj.seqPos = Math.floor((counter/32)*obj.seqMulti) % 2; // Pretend there are two steps
                    seqPosEffective = 0;                              // But always use the first value
                }
                else
                {
                    obj.seqPos = Math.floor((counter/32)*obj.seqMulti) % obj.seqSteps;
                    seqPosEffective = obj.seqPos;
                }            
                if (obj.seqPos != obj.seqPosPrev)
                {                   
                    if (probDo(obj.randomness/100))  // Do something random
                    {
                        if (probDo(0.5))  // Sometimes trigger, sometimes not
                        {
                            if (probDo(0.5))
                            {
                                obj.trigger(time, 1);  // Full velocity trigger
                            }
                            else
                            {                            
                                obj.trigger(time, 0.75);  // Quiet trigger
                            }
                        } 
                    }
                    else  // Follow the actual sequence
                    {
                        if (obj.seq[seqPosEffective] > 0) // && probDo(obj.seq[seqPosEffective]))
                        {
                            if (probDo(obj.density/100))
                            {
                                obj.trigger(time, obj.seq[seqPosEffective]);
                            }                    
                        }
                    }
                }
                obj.seqPosPrev = obj.seqPos;
            }

        </script>
    </body>

</html>
