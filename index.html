<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
	<title>FieldsOS</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.48/Tone.js"></script>
    <style>
        body 
        {
            background-color: #DDDDDD;
        }
        .valueDisplay
        {
            font-size:1.5em;
            margin-left:1em;
        }
        .slider
        {
            width:50%;
            max-width:400px;
        }
        .selector
        {
            height:4em;
            width:4em;
            margin:2em;        
        }
        .selectorLabel
        {
            font-size:2em;  
        }
        
    </style>
</head>

<body>

    <div style="position:absolute; top:50%; transform: translate(-50%, -50%); left:50%; width:80vw; text-align:center;">
        
<button id="b" onClick="go();" style="font-size:85px; border:0px; background-color:rgba(0,0,0,0);">‚ñ∂Ô∏è</button> <button id="regenButton" onClick="regen();" style="font-size:85px; border:0px; background-color:rgba(0,0,0,0);">üîÅ</button>

<pre>                    
  TEMPO: <input type="range" class="slider" min="1" max="200" value="120" oninput="document.getElementById('tempoDisplay').innerHTML=String(this.value).padStart(3,' ');" onchange="Tone.Transport.bpm.value=tempo=this.value; document.getElementById('tempoDisplay').innerHTML=String(this.value).padStart(3,' ');"><span id="tempoDisplay"  class="valueDisplay" >120</span>

<hr/>

  STEPS: <input type="range" class="slider" min="1" max="16" value="16" oninput="document.getElementById('stepsDisplay').innerHTML=String(this.value).padStart(3,' ');" onchange="stepsChanged(this.value);"><span class="valueDisplay" id="stepsDisplay"> 16</span>

  MULTI: <input type="range" class="slider" min="1" max="16" value="8" oninput="document.getElementById('multiDisplay').innerHTML=String(this.value).padStart(3,' ');" onchange="multiChanged(this.value);"><span  class="valueDisplay" id="multiDisplay">  8</span>

DENSITY: <input type="range" class="slider" min="0" max="100" value="100" oninput="document.getElementById('densityDisplay').innerHTML=String(this.value).padStart(3,' ');" onchange="densityChanged(this.value);"><span  class="valueDisplay" id="densityDisplay">100</span>

  DECAY: <input type="range" class="slider" min="1" max="100" value="50" oninput="document.getElementById('decayDisplay').innerHTML=String(this.value).padStart(3,' ');" onchange="decayChanged(this.value);"><span  class="valueDisplay" id="decayDisplay"> 50</span>

</pre>

<div style="width:320px; margin:0 auto; text-align:center;">
<div style="float:left;">
    <div>
        <input type="checkbox" class="selector" id="bdSelector" checked="checked" onchange="bdSelected=this.checked;">
    </div>
    <div>
        <label for="bdSelector" class="selectorLabel">BD</label>
    </div>
</div>
<div style="float:left;">
    <div>
        <input type="checkbox" class="selector" id="hatSelector" checked="checked" onchange="hatSelected=this.checked;">
    </div>
    <div>
        <label for="hatSelector" class="selectorLabel">HAT</label>
    </div>
</div>
<div style="float:left;">
    <div>
        <input type="checkbox" class="selector" id="snrSelector" label="SNR" checked="checked" onchange="snrSelected=this.checked;">
    </div>
    <div>
        <label for="snrSelector" class="selectorLabel">SNR</label>
    </div>
</div>
<br/>
</div>

</div>

	<script type="text/javascript">


        // ------------------------------------------------
        // CONFIGURATION
        // ------------------------------------------------

       VELOCITY_RESPONSE_CURVE = 2;

        // ------------------------------------------------
        // CONTROLS
        // ------------------------------------------------

        var playing = false;
        var tempo = 120;
        var bdSelected = true;
        var hatSelected = true;
        var snrSelected = true;

        function go()
        {
            if (!playing)
            {
                play();
                playing = true;
                document.getElementById("b").innerHTML = '‚è∏';
            }                
            else
            {
                stop();
                playing = false;
                document.getElementById("b").innerHTML = '‚ñ∂Ô∏è';
            }                
        }

        function stop()
        {
            loop.stop();
            Tone.Transport.stop();  
        }

        function play()
        {                        
            counter = 0;
            Tone.Transport.start();                        
            loop.start(0);
        }

        function regen()
        {
            document.getElementById("regenButton").style.backgroundColor='yellow';
            setTimeout(()=>{
                document.getElementById("regenButton").style.backgroundColor='#DDDDDD';
            },100);

            if (bdSelected)  bd.randomize();
            if (hatSelected) hat.randomize();
            if (snrSelected) snr.randomize();                                    
        }

        function stepsChanged(value)
        {                        
            if (bdSelected)  bd.seqSteps=value;
            if (hatSelected) hat.seqSteps=value;
            if (snrSelected) snr.seqSteps=value;
        }

        function multiChanged(value)
        {
            if (bdSelected) bd.seqMulti=value;
            if (hatSelected) hat.seqMulti=value;
            if (snrSelected) snr.seqMulti=value;
        }

        function densityChanged(value)
        {
            if (bdSelected) bd.density=value;
            if (hatSelected) hat.density=value;
            if (snrSelected) snr.density=value;
        }

        function decayChanged(value)
        {
            if (bdSelected) 
            {
                bd.decay = value;
                bd.update();
            }
            if (hatSelected)
            {
                hat.decay = value;
                hat.update();
            }            
            if (snrSelected) 
            {
                snr.decay = value;
                snr.update();
            }
        }

        // ------------------------------------------------
        // PATCHES
        // ------------------------------------------------
    
        class Patch
        {
            decay;
            seq;
            seqSteps;
            seqMulti;
            seqPos = 0;
            seqPosPrev = -1;
            density;        

            randomize()
            {
                this.seq = getSequence(Math.random());
                this.decay = randInt(1,100);
                this.seqSteps = randInt(1,16);
                this.seqMulti = randInt(1,16);
                this.density = randInt(1,100);      
                this.decay = randInt(1,100);
                this.update();
            }
        }

        class BdPatch extends Patch
        {
            bdSynth;
            octaves;    
            frequency;
        
            constructor()
            {                
                super();
                this.bdSynth = new Tone.MembraneSynth().toDestination();
                this.randomize();                                    
            }

            trigger(time,vel)
            {
                vel = Math.pow(vel,VELOCITY_RESPONSE_CURVE);
                this.bdSynth.triggerAttackRelease(this.frequency, "16n", time, vel);
            }

            update()
            {
                this.bdSynth.set({
                    volume: 0,
                    octaves: this.octaves,
                    envelope: {                        
                        decay: Math.pow((this.decay/100),3),
                        release: 10
                    }
                });
            }

            randomize()
            {                
                this.frequency = randInt(20,200); 
                this.octaves = randInt(0,8);
                super.randomize();
            }
        }


        class HatPatch extends Patch
        {
            hatSynth;
            harmonicity;
            resonance;
            modulationIndex;
            frequency;

            constructor()
            {           
                super();     
                this.hatSynth = new Tone.MetalSynth().toDestination();
                this.randomize();
            }

            trigger(time,vel)
            {
                vel = Math.pow(vel,VELOCITY_RESPONSE_CURVE);
                this.hatSynth.triggerAttackRelease("C4", "32n", time, vel);  // TODO: How do note and frequency interact?
            }

            update()
            {
                this.hatSynth.set({
                    volume: -12,
                    harmonicity: this.harmonicity,
                    resonance: this.resonance,
                    modulationIndex: this.modulationIndex,
                    frequency: this.frequency,
                    envelope: {
                        decay: Math.pow((this.decay/100),3),
                        release: 10
                    }
                });
            }

            randomize()
            {                
                this.harmonicity = randInt(0,128); 
                this.resonance = randInt(0,10000);
                this.modulationIndex = randInt(0,256);
                this.frequency = randInt(0,10000);
                super.randomize();
            }
        }


        class SnrPatch extends Patch
        {
            snrNoiseSynth;
            snrToneSynth;
            octaves;
            frequency;
            noiseType;

            constructor()
            {           
                super();     
                this.snrNoiseSynth = new Tone.NoiseSynth().toDestination();
                this.snrToneSynth = new Tone.MembraneSynth().toDestination();       
                this.randomize();
            }

            trigger(time,vel)
            {
                vel = Math.pow(vel,VELOCITY_RESPONSE_CURVE);
                this.snrNoiseSynth.triggerAttackRelease("64n", time, vel); 
                this.snrToneSynth.triggerAttackRelease(this.frequency, "64n", time, vel);      
            }

            update()
            {
                this.snrNoiseSynth.set({
                    volume: -6,
                    noise: {
                        type: this.noiseType
                    },
                    envelope: {
                        decay: Math.pow((this.decay/100),2)*0.1,
                        release: 10
                    }
                });
                this.snrToneSynth.set({
                    volume: -12,
                    octaves: this.octaves,
                    envelope: {
                        decay: Math.pow((this.decay/100),4)*0.1,
                        release: 10
                    }
                });
            }

            randomize()
            {                
                this.frequency = 100+Math.pow(Math.random(),2)*1000;
                this.octaves = Math.pow(Math.random(),2)*8;
                if (probDo(0.33))
                {
                    this.noiseType = "white";
                }
                else
                {
                    if (probDo(0.5))
                    {
                        this.noiseType = "pink";
                    }
                    else
                    {
                        this.noiseType = "brown";
                    }
                }                                
                super.randomize();
            }
        }


        // ------------------------------------------------
        // SEQUENCING
        // ------------------------------------------------
        
        var bd = new BdPatch();
        var hat = new HatPatch(); 
        var snr = new SnrPatch();

        regen(); 

        const loop = new Tone.Loop((time) => {
                                                 
            executeSequence(bd, time);
            executeSequence(hat, time);
            executeSequence(snr, time);

            counter++;

        }, "64n");
  

        // ------------------------------------------------
        // HELPERS
        // ------------------------------------------------
                
        function randInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function probDo(x) 
        {
            return Math.random() < x;
        }

        function getSequence(seqDensity)
        {		
            var seq = [];
            for (var i=0;i<16;i++)
            {
                var f = 0;
                var r = Math.random();
                if (r < seqDensity)
                {
                    f = 1;
                }
                else if (r < 0.3)
                {
                    f = Math.random();				
                }
                else
                {
                    f = 0;
                }
                seq[i] = f;
            }

            if (probDo(0.5))
            {
                seq[0] = 1;
            }

            return seq;
        }

        function executeSequence(obj, time)
        {
            if (obj.seqSteps == 1)  // Special case when step count is 1
            {
                obj.seqPos = Math.floor((counter/32)*obj.seqMulti) % 2; // Pretend there are two steps
                seqPosEffective = 0;                              // But always use the first value
            }
            else
            {
                obj.seqPos = Math.floor((counter/32)*obj.seqMulti) % obj.seqSteps;
                seqPosEffective = obj.seqPos;
            }            
            if (obj.seqPos != obj.seqPosPrev)
            {            
                if (obj.seq[seqPosEffective] > 0 && Math.random() < obj.seq[seqPosEffective]) {
                    if (Math.random() < obj.density/100)
                    {
                        obj.trigger(time, obj.seq[seqPosEffective]);
                    }                    
                }
            }
            obj.seqPosPrev = obj.seqPos;
        }

	</script>
</body>
</html>
